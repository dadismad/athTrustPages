<script lang="ts">

	import { clickOutsideObject, Link } from '$lib';
	import { onMount } from 'svelte';
	import { browser } from '$app/environment';
	import { getCategories, type IGetCategoriesReturn } from '~lib/services';
	import type { ICategoryEntity, IFetchParams } from '~lib/types';

	const host = import.meta.env.VITE_HOST;

	let isShowed = false;
	let animateIn = false;
	let isLoadingCategories = true;
	let categories: ICategoryEntity[] = [];

	let menuButton: HTMLButtonElement;
	let menuElement: HTMLDivElement | null = null;

	const handleClickOutside = (event: MouseEvent) => {
		if (isShowed) {
			clickOutsideObject(event, menuElement, menuButton, () => isShowed = false);
		}
	};

	onMount(() => {
		if (browser) {
			document.addEventListener("mousedown", handleClickOutside, { capture: true });
			isLoadingCategories = true;
			getCategories({ fetch } as IFetchParams)
				.then((res: IGetCategoriesReturn) => {
					categories = res.result.data;
					isLoadingCategories = false;
				});
		}
		return () => {
			if (browser) {
				document.removeEventListener("mousedown", handleClickOutside, { capture: true });
			}
		}
	});

	function disableScroll() {
		if (browser) {
			document.body.style.overflow = "hidden";
		}
	}

	function enableScroll() {
		if (browser) {
			document.body.style.overflow = "";
		}
	}

	const hideMenu = () => setTimeout(() => isShowed = false);

	$: {
		if (animateIn) {
			disableScroll();
		} else {
			enableScroll();
		}
	}


	$: setTimeout(() => {
		animateIn = isShowed;
	});

</script>

<div class="MobileNavigator">

	{#if isShowed}
		<div class="mobile-navigator-backdrop" style={`opacity: ${animateIn ? '1' : '0'}`}></div>
	{/if}

	<div class="mobile-navigator-toggler">

		<button class="toggler" on:click={() => isShowed = !isShowed} bind:this={menuButton}>
			{#if !isShowed}
				<i class="ri-menu-line"/>
			{/if}
			{#if isShowed}
				<i class="ri-menu-line"/>
			{/if}
		</button>

	</div>

	{#if isShowed}
		<div
			class="mobile-menu" style={`display: ${isShowed ? 'block' : 'none'}; transform: translateY(${ animateIn ? '0' : '100%' });`}
			bind:this={menuElement}
			on:mouseup={hideMenu} role="button" tabindex="-1"
		>

			<div class="mobile-menu-content">

				<div class="mobile-menu-head">
					<svg  viewBox="0 0 368 59" fill="none" xmlns="http://www.w3.org/2000/svg">
						<path d="M366.356 0.359985C366.143 2.70665 365.983 4.97332 365.876 7.15998C365.823 9.34665 365.796 11.0267 365.796 12.2C365.796 13.2667 365.823 14.28 365.876 15.24C365.929 16.2 365.983 17 366.036 17.64H364.196C363.663 13.7467 362.836 10.68 361.716 8.43998C360.596 6.14665 359.129 4.54665 357.316 3.63998C355.556 2.67998 353.476 2.19998 351.076 2.19998H347.796C346.249 2.19998 345.076 2.33331 344.276 2.59998C343.476 2.86665 342.943 3.39998 342.676 4.19998C342.409 4.99998 342.276 6.22665 342.276 7.87998V49.48C342.276 51.1333 342.409 52.36 342.676 53.16C342.943 53.96 343.476 54.4933 344.276 54.76C345.076 55.0267 346.249 55.16 347.796 55.16H351.716C354.116 55.16 356.223 54.6533 358.036 53.64C359.903 52.5733 361.476 50.7867 362.756 48.28C364.089 45.7733 365.103 42.3867 365.796 38.12H367.636C367.476 39.8267 367.396 42.0667 367.396 44.84C367.396 46.0667 367.423 47.8 367.476 50.04C367.529 52.28 367.689 54.6 367.956 57C365.236 56.8933 362.169 56.84 358.756 56.84C355.343 56.7866 352.303 56.76 349.636 56.76C348.303 56.76 346.596 56.76 344.516 56.76C342.436 56.76 340.196 56.7866 337.796 56.84C335.396 56.84 332.969 56.8666 330.516 56.92C328.063 56.92 325.743 56.9467 323.556 57V55.4C325.263 55.2933 326.543 55.08 327.396 54.76C328.249 54.44 328.809 53.8 329.076 52.84C329.396 51.88 329.556 50.44 329.556 48.52V8.83998C329.556 6.86665 329.396 5.42665 329.076 4.51998C328.809 3.55998 328.223 2.91998 327.316 2.59998C326.463 2.22665 325.209 2.01332 323.556 1.95998V0.359985C325.743 0.413318 328.063 0.466649 330.516 0.519981C332.969 0.519981 335.396 0.546649 337.796 0.599981C340.196 0.599981 342.436 0.599981 344.516 0.599981C346.596 0.599981 348.303 0.599981 349.636 0.599981C352.089 0.599981 354.863 0.599981 357.956 0.599981C361.103 0.546649 363.903 0.466651 366.356 0.359985ZM353.876 27.72C353.876 27.72 353.876 27.9867 353.876 28.52C353.876 29.0533 353.876 29.32 353.876 29.32H339.876C339.876 29.32 339.876 29.0533 339.876 28.52C339.876 27.9867 339.876 27.72 339.876 27.72H353.876ZM356.196 17.16C355.983 20.2 355.876 22.52 355.876 24.12C355.929 25.72 355.956 27.1867 355.956 28.52C355.956 29.8533 355.983 31.32 356.036 32.92C356.089 34.52 356.223 36.84 356.436 39.88H354.596C354.329 38.0133 353.823 36.28 353.076 34.68C352.383 33.08 351.369 31.8 350.036 30.84C348.703 29.8266 346.969 29.32 344.836 29.32V27.72C346.436 27.72 347.796 27.4 348.916 26.76C350.036 26.0666 350.943 25.1866 351.636 24.12C352.383 23 352.969 21.8267 353.396 20.6C353.823 19.3733 354.143 18.2266 354.356 17.16H356.196Z" fill="#0C8E54"/>
						<path d="M321.638 0.359985V1.95998C320.465 2.38665 319.212 3.31998 317.878 4.75998C316.598 6.19998 315.398 8.43998 314.278 11.48L297.398 57.16C296.972 57.1067 296.518 57.08 296.038 57.08C295.558 57.08 295.078 57.08 294.598 57.08C294.172 57.08 293.718 57.08 293.238 57.08C292.758 57.08 292.305 57.1067 291.878 57.16L271.478 7.07998C270.732 5.15998 269.905 3.85331 268.998 3.15998C268.092 2.41331 267.238 2.01332 266.438 1.95998V0.359985C268.038 0.413318 269.905 0.466649 272.038 0.519981C274.225 0.573314 276.412 0.599981 278.598 0.599981C281.052 0.599981 283.345 0.573314 285.478 0.519981C287.665 0.466649 289.425 0.413318 290.758 0.359985V1.95998C289.052 2.01332 287.718 2.22665 286.758 2.59998C285.798 2.91998 285.265 3.55998 285.158 4.51998C285.052 5.42665 285.372 6.81331 286.118 8.67998L300.678 45.72L298.998 47.72L310.038 17.96C311.478 13.96 312.225 10.8133 312.278 8.51999C312.332 6.22665 311.772 4.57332 310.598 3.55998C309.425 2.54665 307.745 2.01332 305.558 1.95998V0.359985C307.372 0.413318 309.078 0.466649 310.678 0.519981C312.278 0.573314 313.905 0.599981 315.558 0.599981C316.732 0.599981 317.825 0.573314 318.838 0.519981C319.905 0.466649 320.838 0.413318 321.638 0.359985Z" fill="#0C8E54"/>
						<path d="M264.76 0.359985V1.95998C263.054 2.01332 261.747 2.22665 260.84 2.59998C259.987 2.91998 259.427 3.55998 259.16 4.51998C258.894 5.42665 258.76 6.86665 258.76 8.83998V48.52C258.76 50.44 258.894 51.88 259.16 52.84C259.48 53.8 260.067 54.44 260.92 54.76C261.774 55.08 263.054 55.2933 264.76 55.4V57C263.32 56.8933 261.507 56.84 259.32 56.84C257.134 56.7866 254.92 56.76 252.68 56.76C250.067 56.76 247.64 56.7866 245.4 56.84C243.214 56.84 241.427 56.8933 240.04 57V55.4C241.747 55.2933 243.027 55.08 243.88 54.76C244.734 54.44 245.294 53.8 245.56 52.84C245.88 51.88 246.04 50.44 246.04 48.52V8.83998C246.04 6.86665 245.88 5.42665 245.56 4.51998C245.294 3.55998 244.707 2.91998 243.8 2.59998C242.947 2.22665 241.694 2.01332 240.04 1.95998V0.359985C241.427 0.413318 243.214 0.466649 245.4 0.519981C247.64 0.573314 250.067 0.599981 252.68 0.599981C254.92 0.599981 257.134 0.573314 259.32 0.519981C261.507 0.466649 263.32 0.413318 264.76 0.359985Z" fill="#0C8E54"/>
						<path d="M216.334 0.359985V1.95998C214.521 2.01332 213.134 2.22665 212.174 2.59998C211.267 2.91998 210.654 3.55998 210.334 4.51998C210.014 5.42665 209.854 6.86665 209.854 8.83998V49.48C209.854 51.1333 209.961 52.36 210.174 53.16C210.441 53.96 210.921 54.4933 211.614 54.76C212.361 55.0267 213.454 55.16 214.894 55.16H218.814C220.627 55.16 222.334 54.7333 223.934 53.88C225.534 53.0266 226.974 51.8266 228.254 50.28C229.534 48.68 230.601 46.7866 231.454 44.6C232.307 42.4133 232.947 39.9867 233.374 37.32H235.214C235.054 39.1333 234.974 41.48 234.974 44.36C234.974 45.5867 235.001 47.3733 235.054 49.72C235.107 52.0667 235.267 54.4933 235.534 57C232.814 56.8933 229.747 56.84 226.334 56.84C222.921 56.7866 219.881 56.76 217.214 56.76C215.881 56.76 214.174 56.76 212.094 56.76C210.014 56.76 207.774 56.7866 205.374 56.84C202.974 56.84 200.547 56.8666 198.094 56.92C195.641 56.92 193.321 56.9467 191.134 57V55.4C192.841 55.2933 194.121 55.08 194.974 54.76C195.827 54.44 196.387 53.8 196.654 52.84C196.974 51.88 197.134 50.44 197.134 48.52V8.83998C197.134 6.86665 196.974 5.42665 196.654 4.51998C196.387 3.55998 195.801 2.91998 194.894 2.59998C194.041 2.22665 192.787 2.01332 191.134 1.95998V0.359985C192.467 0.413318 194.254 0.466649 196.494 0.519981C198.787 0.573314 201.214 0.599981 203.774 0.599981C206.121 0.599981 208.414 0.573314 210.654 0.519981C212.947 0.466649 214.841 0.413318 216.334 0.359985Z" fill="#0C8E54"/>
						<path d="M177.652 45.8C179.732 45.8 181.385 46.36 182.612 47.48C183.838 48.5467 184.452 50.04 184.452 51.96C184.452 53.88 183.838 55.4 182.612 56.52C181.385 57.5867 179.732 58.12 177.652 58.12C175.572 58.12 173.918 57.5867 172.692 56.52C171.465 55.4 170.852 53.88 170.852 51.96C170.852 50.04 171.465 48.5467 172.692 47.48C173.918 46.36 175.572 45.8 177.652 45.8Z" fill="#0C8E54"/>
						<path d="M139.507 57V55.4C141.214 55.2933 142.494 55.08 143.347 54.76C144.201 54.44 144.76 53.8 145.027 52.84C145.347 51.88 145.507 50.44 145.507 48.52V8.83998C145.507 6.86665 145.347 5.42665 145.027 4.51998C144.76 3.55998 144.174 2.91998 143.267 2.59998C142.414 2.22665 141.16 2.01332 139.507 1.95998V0.359985C140.947 0.413318 142.814 0.466649 145.107 0.519981C147.454 0.573314 149.774 0.599981 152.067 0.599981C154.52 0.599981 156.814 0.573314 158.947 0.519981C161.134 0.466649 162.894 0.413318 164.227 0.359985V1.95998C162.52 2.01332 161.214 2.22665 160.307 2.59998C159.454 2.91998 158.894 3.55998 158.627 4.51998C158.361 5.42665 158.227 6.86665 158.227 8.83998V48.52C158.227 50.44 158.361 51.88 158.627 52.84C158.947 53.8 159.534 54.44 160.387 54.76C161.24 55.08 162.52 55.2933 164.227 55.4V57C162.894 56.8933 161.134 56.84 158.947 56.84C156.814 56.7866 154.52 56.76 152.067 56.76C149.774 56.76 147.454 56.7866 145.107 56.84C142.814 56.84 140.947 56.8933 139.507 57ZM105.587 57V55.4C107.294 55.2933 108.574 55.08 109.427 54.76C110.28 54.44 110.84 53.8 111.107 52.84C111.427 51.88 111.587 50.44 111.587 48.52V8.83998C111.587 6.86665 111.427 5.42665 111.107 4.51998C110.84 3.55998 110.254 2.91998 109.347 2.59998C108.494 2.22665 107.24 2.01332 105.587 1.95998V0.359985C106.974 0.413318 108.76 0.466649 110.947 0.519981C113.187 0.573314 115.614 0.599981 118.227 0.599981C120.467 0.599981 122.68 0.573314 124.867 0.519981C127.054 0.466649 128.867 0.413318 130.307 0.359985V1.95998C128.6 2.01332 127.294 2.22665 126.387 2.59998C125.534 2.91998 124.974 3.55998 124.707 4.51998C124.44 5.42665 124.307 6.86665 124.307 8.83998V48.52C124.307 50.44 124.44 51.88 124.707 52.84C125.027 53.8 125.614 54.44 126.467 54.76C127.32 55.08 128.6 55.2933 130.307 55.4V57C128.867 56.8933 127.054 56.84 124.867 56.84C122.68 56.7866 120.467 56.76 118.227 56.76C115.614 56.76 113.187 56.7866 110.947 56.84C108.76 56.84 106.974 56.8933 105.587 57ZM119.107 29.32V27.72H150.707V29.32H119.107Z" fill="white"/>
						<path d="M100.79 0.359985C100.576 3.07999 100.416 5.69332 100.31 8.19998C100.256 10.7066 100.23 12.6266 100.23 13.96C100.23 15.1333 100.256 16.2533 100.31 17.32C100.363 18.3867 100.416 19.2933 100.47 20.04H98.6297C97.7764 15.56 96.683 12.0133 95.3497 9.39998C94.0697 6.78665 92.523 4.94665 90.7097 3.87998C88.8964 2.75998 86.763 2.19998 84.3097 2.19998H82.4697V47.88C82.4697 50.0133 82.683 51.6133 83.1097 52.68C83.5897 53.7467 84.443 54.4666 85.6697 54.84C86.8964 55.16 88.683 55.3467 91.0297 55.4V57C89.3764 56.9467 87.163 56.8933 84.3897 56.84C81.6697 56.7866 78.8164 56.76 75.8297 56.76C72.8964 56.76 70.123 56.7866 67.5097 56.84C64.8964 56.8933 62.7897 56.9467 61.1897 57V55.4C63.5897 55.3467 65.403 55.16 66.6297 54.84C67.8564 54.4666 68.683 53.7467 69.1097 52.68C69.5364 51.6133 69.7497 50.0133 69.7497 47.88V2.19998H67.9897C65.5364 2.19998 63.403 2.75998 61.5897 3.87998C59.7764 4.94665 58.2297 6.78665 56.9497 9.39998C55.6697 11.96 54.5497 15.5067 53.5897 20.04H51.7497C51.8564 19.2933 51.9097 18.3867 51.9097 17.32C51.963 16.2533 51.9897 15.1333 51.9897 13.96C51.9897 12.6266 51.9364 10.7066 51.8297 8.19998C51.7764 5.69332 51.643 3.07999 51.4297 0.359985C53.883 0.413318 56.5497 0.466649 59.4297 0.519981C62.363 0.573314 65.2964 0.599981 68.2297 0.599981C71.163 0.599981 73.803 0.599981 76.1497 0.599981C78.5497 0.599981 81.1897 0.599981 84.0697 0.599981C87.003 0.599981 89.9364 0.573314 92.8697 0.519981C95.803 0.466649 98.443 0.413318 100.79 0.359985Z" fill="white"/>
						<path d="M30.901 0.200012L50.341 50.28C51.0877 52.2 51.9143 53.5333 52.821 54.28C53.781 54.9733 54.6343 55.3467 55.381 55.4V57C53.781 56.8933 51.8877 56.84 49.701 56.84C47.5677 56.7867 45.4077 56.76 43.221 56.76C40.7677 56.76 38.4477 56.7867 36.261 56.84C34.0743 56.84 32.341 56.8933 31.061 57V55.4C33.781 55.2934 35.4877 54.84 36.181 54.04C36.9277 53.1867 36.7677 51.4 35.701 48.68L22.101 11.48L23.541 9.40001L11.381 41.08C10.2077 44.0133 9.48765 46.4133 9.22099 48.28C9.00765 50.1467 9.14099 51.5867 9.62099 52.6C10.1543 53.6133 10.981 54.3334 12.101 54.76C13.2743 55.1334 14.661 55.3467 16.261 55.4V57C14.501 56.8933 12.821 56.84 11.221 56.84C9.62099 56.7867 7.99432 56.76 6.34099 56.76C5.16765 56.76 4.04765 56.7867 2.98099 56.84C1.96765 56.84 1.06099 56.8933 0.260986 57V55.4C1.38099 55.1867 2.52765 54.4667 3.70099 53.24C4.87432 52.0133 6.02099 49.9333 7.14099 47L25.381 0.200012C26.2343 0.253345 27.141 0.28001 28.101 0.28001C29.1143 0.28001 30.0477 0.253345 30.901 0.200012ZM36.501 33.96V35.56H12.661L13.461 33.96H36.501Z" fill="white"/>
					</svg>

				</div>

				<div class="navigator-group">
					Main Menu
				</div>

				<div class="navigator-link">
					<Link href={`${host}/`}>News</Link>
				</div>
				<div class="navigator-link">
					<div>
						<Link href={`${host}/categories`}>Categories</Link>
					</div>
					<div class="py-3">
						{#if isLoadingCategories}
							Loading...
						{:else}
							{#each categories as category}
								{#if category.category_code && category.category_name}
									<a href={`${host}/categories/${category.category_code}`}>
										<div class="navigator-link-secondary">
											{category.category_name}
										</div>
									</a>
								{/if}
							{/each}
						{/if}
					</div>
				</div>
				<div class="navigator-link">
					<Link href={`${host}/events`}>Events</Link>
				</div>

			</div>
		</div>
	{/if}
</div>

<style lang="scss">

  @import "~lib/styles/variables";

  .mobile-navigator-backdrop {
    position: fixed;
    z-index: $zindex-modal-backdrop;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.8);
    transition: opacity 1s ease-in-out;
  }

  .mobile-navigator-toggler {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: $zindex-modal;

    .toggler {
      padding: 1rem;
      background: var(--color-bg-primary-100);
      color: var(--color-text-inv-100);
      border-radius: 50%;
      line-height: 1;
      font-size: 1.5rem;
      display: block;
      box-shadow: 0 0 12px rgba(0,0,0,0.2);
      border: 2px solid var(--color-bg-base-100);

      //.icon::before {
      //  display: block;
      //  width: 1.5rem;
      //  height: 1.5rem;
      //}
    }

  }

  .mobile-menu {
    position: fixed;
    transform: translateY(100%);
    transition: transform .3s ease-in-out;
    z-index: $zindex-modal;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: rgba(255, 255, 255, 0.99);
    height: 70%;
    border-radius: var(--border-radius-panel) var(--border-radius-panel) 0 0;
    box-shadow: 0 0 24px rgba(0,0,0,0.2);
    padding: 2rem;
    font-size: 1.5rem;
  }

  .mobile-menu-content {
    padding: 1rem;
    position: absolute;
    top: 1rem;
    left: 1rem;
    right: 1rem;
    bottom: 1rem;
    overflow-y: scroll;

    .navigator-group {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--text-muted-100);
      padding: 2rem 0 1rem;
      border-bottom: 1px solid var(--color-line-base-100);
    }

    .navigator-link {
      padding: 1rem 0;
      border-bottom: 1px solid var(--color-line-base-100);
    }

    .navigator-link-secondary {
      display: inline-block;
      padding: .5rem 1rem;
			background: var(--color-bg-base-300);
      margin-bottom: .25rem;
			border-radius: 18px;
      font-size: 1rem;
    }
    a, a:link, a:visited, a:hover {
      text-decoration: none;
    }
  }

  .mobile-menu-head {
    background: var(--color-bg-inv-100);
    padding: 1rem;
    border-radius: var(--border-radius-panel);
    margin-bottom: 1rem;
    text-align: center;
		> svg {
      margin: 0 auto;
			max-width: 220px;
		}
  }

</style>
